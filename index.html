<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icon.png">

<script>
  // Registrar el Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activa-T Gym Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. PEGA TUS DATOS DE FIREBASE AQUÍ ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVT1Mx8dbizJ9nXBIXJcIWjcof_b0fsec",
            authDomain: "activa-t-aea86.firebaseapp.com",
            projectId: "activa-t-aea86",
            storageBucket: "activa-t-aea86.firebasestorage.app",
            messagingSenderId: "180811299847",
            appId: "1:180811299847:web:9ba9668e41ab998f47fea2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Hacemos que React pueda usar Firebase
        window.db = db;
        window.firestore = { collection, addDoc, onSnapshot, query, orderBy };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function GymApp() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [workouts, setWorkouts] = useState([]);
            const [view, setView] = useState('login');
            const [formData, setFormData] = useState({ email: '', password: '', name: '' });
            const [workoutData, setWorkoutData] = useState({ title: '', description: '', image: null });
            const [selectedClient, setSelectedClient] = useState('');

            // --- ESCUCHAR DATOS EN TIEMPO REAL ---
            useEffect(() => {
                if (!window.db) return;

                // Escuchar Usuarios
                const qUsers = window.firestore.query(window.firestore.collection(window.db, "usuarios"));
                const unsubUsers = window.firestore.onSnapshot(qUsers, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Si no hay admin, lo creamos virtualmente para el login
                    const adminExist = docs.find(u => u.role === 'admin');
                    if (!adminExist) docs.push({ email: 'ggcaparra38@gmail.com', password: 'templerenovatio', name: 'Admin', role: 'admin' });
                    setUsers(docs);
                });

                // Escuchar Rutinas
                const qWorkouts = window.firestore.query(
                    window.firestore.collection(window.db, "rutinas"),
                    window.firestore.orderBy("createdAt", "desc")
                );
                const unsubWorkouts = window.firestore.onSnapshot(qWorkouts, (snapshot) => {
                    setWorkouts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubUsers(); unsubWorkouts(); };
            }, []);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setWorkoutData({...workoutData, image: reader.result});
                    reader.readAsDataURL(file);
                }
            };

            const handleLogin = () => {
                const user = users.find(u => u.email === formData.email && u.password === formData.password);
                if (user) {
                    setCurrentUser(user);
                    setView(user.role === 'admin' ? 'admin' : 'client');
                } else alert("Datos incorrectos");
            };

            const handleRegister = async () => {
                try {
                    await window.firestore.addDoc(window.firestore.collection(window.db, "usuarios"), {
                        ...formData,
                        role: 'client',
                        createdAt: new Date().toISOString()
                    });
                    alert("Cliente registrado en la nube");
                    setView('login');
                } catch (e) { alert("Error al registrar"); }
            };

            const handleSendWorkout = async () => {
                if (!selectedClient || !workoutData.title) return alert("Faltan datos");
                try {
                    await window.firestore.addDoc(window.firestore.collection(window.db, "rutinas"), {
                        clientId: selectedClient,
                        title: workoutData.title,
                        description: workoutData.description,
                        image: workoutData.image,
                        date: new Date().toLocaleDateString(),
                        createdAt: new Date().toISOString()
                    });
                    setWorkoutData({ title: '', description: '', image: null });
                    alert("¡Rutina enviada a la nube!");
                } catch (e) { alert("Error al enviar"); }
            };

            // (El resto de las vistas Login, Register, Admin y Client se mantienen igual que en la versión anterior)
            // Solo asegúrate de copiar el 'return' de las vistas del código anterior aquí abajo.
            
            if (view === 'login') return (
                <div className="min-h-screen bg-blue-600 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-center mb-6 text-blue-800 italic">ACTIVA-T CLOUD</h1>
                        <input className="w-full p-3 border rounded mb-3" placeholder="Email" onChange={e => setFormData({...formData, email: e.target.value})} />
                        <input className="w-full p-3 border rounded mb-3" type="password" placeholder="Contraseña" onChange={e => setFormData({...formData, password: e.target.value})} />
                        <button onClick={handleLogin} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">ENTRAR</button>
                        <button onClick={() => setView('register')} className="w-full mt-4 text-blue-600 text-sm italic">Registrar cliente</button>
                    </div>
                </div>
            );

            if (view === 'register') return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <h2 className="text-xl font-bold mb-4">Nuevo Cliente Cloud</h2>
                        <input className="w-full p-3 border rounded mb-3" placeholder="Nombre" onChange={e => setFormData({...formData, name: e.target.value})} />
                        <input className="w-full p-3 border rounded mb-3" placeholder="Email" onChange={e => setFormData({...formData, email: e.target.value})} />
                        <input className="w-full p-3 border rounded mb-3" type="password" placeholder="Contraseña" onChange={e => setFormData({...formData, password: e.target.value})} />
                        <button onClick={handleRegister} className="w-full bg-green-600 text-white p-3 rounded-lg font-bold">CREAR EN NUBE</button>
                        <button onClick={() => setView('login')} className="w-full mt-2 text-gray-500 text-xs text-center block">Volver</button>
                    </div>
                </div>
            );

            if (view === 'admin') return (
                <div className="min-h-screen bg-gray-50">
                    <nav className="bg-blue-800 p-4 text-white flex justify-between">
                        <span className="font-bold">ADMIN (CLOUD)</span>
                        <button onClick={() => setView('login')} className="text-xs">Salir</button>
                    </nav>
                    <div className="p-4 max-w-xl mx-auto">
                        <div className="bg-white p-6 rounded-xl shadow">
                            <select className="w-full p-3 border rounded mb-4" onChange={e => setSelectedClient(e.target.value)}>
                                <option value="">Selecciona cliente...</option>
                                {users.filter(u => u.role === 'client').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                            <input className="w-full p-3 border rounded mb-4" placeholder="Título" value={workoutData.title} onChange={e => setWorkoutData({...workoutData, title: e.target.value})} />
                            <textarea className="w-full p-3 border rounded mb-4" placeholder="Ejercicios..." value={workoutData.description} onChange={e => setWorkoutData({...workoutData, description: e.target.value})}></textarea>
                            <input type="file" accept="image/*" onChange={handleImageChange} className="mb-4 text-xs" />
                            <button onClick={handleSendWorkout} className="w-full bg-blue-600 text-white p-4 rounded font-bold">ENVIAR A LA NUBE</button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'client') return (
                <div className="min-h-screen bg-gray-100">
                    <nav className="bg-indigo-700 p-4 text-white font-bold">MIS RUTINAS ONLINE</nav>
                    <div className="p-4 max-w-lg mx-auto">
                        {workouts.filter(w => w.clientId === currentUser.id).map(w => (
                            <div key={w.id} className="bg-white rounded-xl shadow mb-6 overflow-hidden">
                                {w.image && <img src={w.image} className="w-full h-48 object-cover" />}
                                <div className="p-4">
                                    <h3 className="font-bold text-lg">{w.title}</h3>
                                    <p className="text-gray-600 text-sm mt-2">{w.description}</p>
                                    <div className="text-[10px] text-gray-400 mt-2 text-right">{w.date}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GymApp />);
    </script>
</body>
</html>
